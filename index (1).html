<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- è¨­å®š viewport ç¢ºä¿æ‰‹æ©Ÿç‰ˆå‹æ­£ç¢º -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯è¨˜å¸³æœ¬ (Firebase ç‰ˆæœ¬)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Inter å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Microsoft JhengHei', 'sans-serif';
            background-color: #f0f4f8; /* æŸ”å’Œçš„æ·ºè—ç°èƒŒæ™¯ */
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .text-income { color: #10b981; } /* Emerald Green */
        .text-expense { color: #ef4444; } /* Red */
    </style>
</head>
<body>

    <div id="app" class="max-w-md mx-auto p-4 sm:p-6 bg-white min-h-screen">
        <header class="text-center mb-6 pt-4">
            <h1 class="text-3xl font-extrabold text-gray-900">é›²ç«¯è¨˜å¸³æœ¬</h1>
            <p id="user-id-display" class="text-xs text-gray-500 mt-1">
                <!-- é¡¯ç¤ºä½¿ç”¨è€… ID ä»¥ç¢ºä¿é€£ç·šæˆåŠŸ -->
            </p>
        </header>

        <!-- è¨Šæ¯å½ˆçª—: ç”¨æ–¼å–ä»£ alert/confirm -->
        <div id="message-box" class="fixed top-0 left-1/2 -translate-x-1/2 w-11/12 max-w-sm z-50"></div>

        <!-- ç¸½çµæ•¸æ“šå€å¡Š -->
        <div id="summary-section" class="mb-6 grid grid-cols-3 gap-3">
            <!-- ç¸½æ”¶å…¥å¡ç‰‡ -->
            <div class="card bg-white p-3 rounded-xl text-center border-l-4 border-emerald-500">
                <p class="text-xs text-gray-500 font-semibold">ç¸½æ”¶å…¥</p>
                <p id="total-income" class="text-income text-lg font-bold mt-1">NT$ 0</p>
            </div>
            <!-- ç¸½æ”¯å‡ºå¡ç‰‡ -->
            <div class="card bg-white p-3 rounded-xl text-center border-l-4 border-red-500">
                <p class="text-xs text-gray-500 font-semibold">ç¸½æ”¯å‡º</p>
                <p id="total-expense" class="text-expense text-lg font-bold mt-1">NT$ 0</p>
            </div>
            <!-- æ·¨é¤˜é¡å¡ç‰‡ -->
            <div id="net-balance-card" class="card p-3 rounded-xl text-white text-center transition duration-300 bg-gray-500">
                <p class="text-xs font-semibold">æ·¨é¤˜é¡</p>
                <p id="net-balance" class="text-lg font-bold mt-1">NT$ 0</p>
            </div>
        </div>

        <!-- æ–°å¢äº¤æ˜“å€å¡Š -->
        <section class="mb-8 p-5 bg-white rounded-2xl card border-t-8 border-orange-500">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">æ–°å¢äº¤æ˜“</h2>
            <div class="space-y-4">
                <!-- é¡å‹é¸æ“‡ (æ”¯å‡º/æ”¶å…¥) -->
                <div>
                    <label for="transaction-type" class="block text-sm font-medium text-gray-600 mb-1">é¡å‹</label>
                    <select id="transaction-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150">
                        <option value="expense">æ”¯å‡º (Expense)</option>
                        <option value="income">æ”¶å…¥ (Income)</option>
                    </select>
                </div>

                <!-- æè¿° -->
                <div>
                    <label for="transaction-description" class="block text-sm font-medium text-gray-600 mb-1">æè¿° (ä¾‹å¦‚: åˆé¤, åŠ ç­è²»)</label>
                    <!-- **é—œéµ APK ä¿®æ­£:** åŠ å…¥ onclick å±¬æ€§ä»¥å”åŠ© WebView è§¸ç™¼éµç›¤ -->
                    <input type="text" id="transaction-description" placeholder="è¼¸å…¥æè¿°" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150" required onclick="this.focus()">
                </div>

                <!-- é‡‘é¡ -->
                <div>
                    <label for="transaction-amount" class="block text-sm font-medium text-gray-600 mb-1">é‡‘é¡ (NT$)</label>
                     <!-- **é—œéµ APK ä¿®æ­£:** åŠ å…¥ onclick å±¬æ€§ä»¥å”åŠ© WebView è§¸ç™¼éµç›¤ -->
                    <input type="number" id="transaction-amount" placeholder="è¼¸å…¥é‡‘é¡ (ä¾‹å¦‚: 150)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150" required onclick="this.focus()">
                </div>

                <!-- ç¢ºèªæ–°å¢æŒ‰éˆ• -->
                <button onclick="addTransaction()" id="add-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-lg transition duration-300 transform hover:scale-[1.01] shadow-lg shadow-orange-300">
                    ç¢ºèªæ–°å¢
                </button>
            </div>
        </section>

        <!-- æ­·å²è¨˜éŒ„å€å¡Š -->
        <section class="p-5 bg-white rounded-2xl card">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">æ­·å²è¨˜éŒ„</h2>
            <div id="history-list" class="space-y-3">
                <p id="loading-message" class="text-center text-gray-500 py-4">é€£ç·šä¸­ï¼Œè«‹ç¨å€™...</p>
                <!-- äº¤æ˜“é …ç›®å°‡å³æ™‚è¼‰å…¥æ–¼æ­¤ -->
            </div>
        </section>

        <!-- ç©ºè³‡æ–™ç‹€æ…‹é¡¯ç¤º -->
        <div id="empty-state" class="text-center p-6 bg-gray-100 rounded-lg hidden mt-4">
            <p class="text-gray-500 text-sm">æš«ç„¡äº¤æ˜“è¨˜éŒ„ã€‚æ‚¨çš„è³‡æ–™å°‡å„²å­˜åœ¨é›²ç«¯ï¼Œè«‹æ”¾å¿ƒæ–°å¢ï¼</p>
        </div>
    </div>

    <!-- Firebase è…³æœ¬åŠæ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. ç’°å¢ƒè®Šæ•¸è¨­å®š (ä¾†è‡ª Canvas ç’°å¢ƒ) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // å…¨åŸŸè®Šæ•¸
        window.db = null;
        window.auth = null;
        window.userId = null;
        
        // åŒ¯å‡ºå‡½å¼åˆ° window ç‰©ä»¶ï¼Œè®“ HTML å¯ä»¥å‘¼å«
        window.addTransaction = addTransaction;
        window.deleteTransaction = deleteTransaction;

        // --- 2. è¼”åŠ©/é€šç”¨å‡½å¼ ---

        /**
         * é¡¯ç¤ºæµ®å‹•è¨Šæ¯ (å–ä»£ alert/confirm)ã€‚
         * @param {string} message - è¨Šæ¯å…§å®¹ã€‚
         * @param {'success'|'error'|'warning'} type - è¨Šæ¯é¡å‹ã€‚
         */
        function showMessage(message, type) {
            const box = document.getElementById('message-box');
            const colorMap = {
                success: 'bg-emerald-500',
                error: 'bg-red-500',
                warning: 'bg-amber-500'
            };
            
            const alertHtml = `
                <div class="${colorMap[type]} text-white p-3 mt-4 rounded-lg shadow-xl transition-all duration-300 ease-in-out transform scale-100 opacity-100 font-medium">
                    ${message}
                </div>
            `;
            
            box.innerHTML = alertHtml;
            
            setTimeout(() => {
                const element = box.querySelector('div');
                if (element) {
                    element.classList.remove('scale-100', 'opacity-100');
                    element.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => box.innerHTML = '', 300);
                }
            }, 3000);
        }

        /**
         * æ ¼å¼åŒ–é‡‘é¡ç‚º NT$ æ ¼å¼ã€‚
         */
        function fmtMoney(amount) {
            return `NT$ ${Math.abs(amount).toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`;
        }

        /**
         * æ ¼å¼åŒ–æ—¥æœŸç‚ºæœˆ/æ—¥ æ™‚:åˆ†ã€‚
         */
        function formatDate(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${month}/${day} ${hours}:${minutes}`;
        }

        // --- 3. Firebase æ ¸å¿ƒè¨­å®šèˆ‡é©—è­‰ ---

        /**
         * åˆå§‹åŒ– Firebase ä¸¦é€²è¡Œä½¿ç”¨è€…é©—è­‰ã€‚
         */
        async function setupFirebase() {
            setLogLevel('debug'); // é–‹å•ŸåµéŒ¯æ—¥èªŒ

            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                // åŸ·è¡Œè‡ªå‹•é©—è­‰ï¼Œç¢ºä¿è³‡æ–™å®‰å…¨å­˜å–
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                
                window.userId = window.auth.currentUser.uid;
                
                // é¡¯ç¤ºä½¿ç”¨è€… ID
                document.getElementById('user-id-display').textContent = `ID: ${window.userId}`;
                
                // é©—è­‰æˆåŠŸå¾Œï¼Œå•Ÿå‹•è³‡æ–™ç›£è½
                fetchTransactions();

            } catch (error) {
                console.error("Firebase è¨­å®šæˆ–ç™»å…¥å¤±æ•—:", error);
                showMessage('Firebase é€£ç·šå¤±æ•—ã€‚', 'error');
            }
        }

        // --- 4. Firestore è³‡æ–™æ“ä½œ (CRUD) ---

        /**
         * æ–°å¢ä¸€ç­†äº¤æ˜“è¨˜éŒ„ã€‚
         */
        async function addTransaction() {
            if (!window.db || !window.userId) {
                showMessage('æ‡‰ç”¨ç¨‹å¼å°šæœªæº–å‚™å¥½ã€‚', 'warning');
                return;
            }

            const typeEl = document.getElementById('transaction-type');
            const descEl = document.getElementById('transaction-description');
            const amountEl = document.getElementById('transaction-amount');

            const type = typeEl.value;
            const description = descEl.value.trim();
            const amount = parseFloat(amountEl.value);

            if (isNaN(amount) || amount <= 0 || !description) {
                showMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡å’Œæè¿°ã€‚', 'warning');
                return;
            }

            document.getElementById('add-button').textContent = 'æ–°å¢ä¸­...';
            document.getElementById('add-button').disabled = true;

            try {
                // è³‡æ–™è·¯å¾‘: artifacts/{appId}/users/{userId}/transactions
                const transactionRef = collection(window.db, 'artifacts', appId, 'users', window.userId, 'transactions');
                
                await addDoc(transactionRef, {
                    type,
                    description,
                    amount,
                    createdAt: serverTimestamp() // ä½¿ç”¨ä¼ºæœå™¨æ™‚é–“æˆ³è¨˜
                });
                
                // æˆåŠŸå›é¥‹èˆ‡æ¸…ç©º
                descEl.value = '';
                amountEl.value = '';
                showMessage('âœ… äº¤æ˜“æ–°å¢æˆåŠŸï¼', 'success');

            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage('æ–°å¢äº¤æ˜“å¤±æ•—: ' + error.message, 'error');
            } finally {
                document.getElementById('add-button').textContent = 'ç¢ºèªæ–°å¢';
                document.getElementById('add-button').disabled = false;
            }
        }

        /**
         * åˆªé™¤ä¸€ç­†äº¤æ˜“è¨˜éŒ„ã€‚
         * è¨»: åœ¨çœŸå¯¦æ‡‰ç”¨ä¸­ï¼Œæœƒåœ¨é€™è£¡å½ˆå‡ºè‡ªå®šç¾©ç¢ºèªæ¡†ã€‚
         * @param {string} docId - äº¤æ˜“æ–‡ä»¶çš„ IDã€‚
         */
        async function deleteTransaction(docId) {
            if (!window.db || !window.userId) {
                showMessage('æ‡‰ç”¨ç¨‹å¼å°šæœªæº–å‚™å¥½ã€‚', 'warning');
                return;
            }

            try {
                const docRef = doc(window.db, 'artifacts', appId, 'users', window.userId, 'transactions', docId);
                await deleteDoc(docRef);
                showMessage('ğŸ—‘ï¸ äº¤æ˜“å·²åˆªé™¤ã€‚', 'warning');
            } catch (error) {
                console.error("Error removing document: ", error);
                showMessage('åˆªé™¤äº¤æ˜“å¤±æ•—: ' + error.message, 'error');
            }
        }


        // --- 5. UI å³æ™‚æ›´æ–° (onSnapshot) ---

        /**
         * ç›£è½ Firestore äº¤æ˜“è³‡æ–™ä¸¦å³æ™‚æ›´æ–° UIã€‚
         */
        function fetchTransactions() {
            if (!window.db || !window.userId) return;

            const transactionCollectionRef = collection(window.db, 'artifacts', appId, 'users', window.userId, 'transactions');
            // ç”±æ–¼ Firestore ä¸æ”¯æ´ç›´æ¥å° serverTimestamp æ’åºï¼Œæˆ‘å€‘éœ€è¦ä½¿ç”¨ JavaScript åœ¨æœ¬åœ°æ’åºã€‚
            // é€™è£¡ä¸ä½¿ç”¨ orderByï¼Œé¿å…éœ€è¦å»ºç«‹ç´¢å¼•ã€‚
            const q = transactionCollectionRef; 

            // å•Ÿå‹•å³æ™‚ç›£è½
            onSnapshot(q, (snapshot) => {
                let totalIncome = 0;
                let totalExpense = 0;
                let transactions = []; // ç”¨æ–¼å„²å­˜å¾ Firestore ç²å–çš„è³‡æ–™

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const amount = data.amount || 0;
                    const type = data.type;
                    
                    if (type === 'income') {
                        totalIncome += amount;
                    } else if (type === 'expense') {
                        totalExpense += amount;
                    }

                    // è™•ç†æ—¥æœŸç‰©ä»¶ï¼ˆå¦‚æœ createdAt å­˜åœ¨ï¼‰
                    const dateObj = data.createdAt ? data.createdAt.toDate() : new Date();

                    transactions.push({
                        ...data,
                        id: doc.id,
                        date: dateObj,
                        timestamp: dateObj.getTime() // ç²å–æ™‚é–“æˆ³è¨˜ç”¨æ–¼æ’åº
                    });
                });

                // **æœ¬åœ°æ’åº:** æŒ‰ç…§æ™‚é–“æˆ³è¨˜é™å†ªæ’åˆ— (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
                transactions.sort((a, b) => b.timestamp - a.timestamp);

                // æ›´æ–° UI
                updateSummary(totalIncome, totalExpense);
                renderHistory(transactions);

            }, (error) => {
                console.error("Error listening to transactions: ", error);
                showMessage('ç„¡æ³•å³æ™‚æ›´æ–°è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', 'error');
            });
        }

        /**
         * æ›´æ–°é é¢ä¸Šçš„ç¸½çµå€å¡Šã€‚
         */
        function updateSummary(income, expense) {
            const netBalance = income - expense;

            document.getElementById('total-income').textContent = fmtMoney(income);
            document.getElementById('total-expense').textContent = fmtMoney(expense);
            document.getElementById('net-balance').textContent = fmtMoney(netBalance);
            
            // æ ¹æ“šé¤˜é¡æ­£è² è¨­å®šå¡ç‰‡é¡è‰²
            const balanceEl = document.getElementById('net-balance-card');
            balanceEl.classList.remove('bg-orange-500', 'bg-emerald-500', 'bg-red-500', 'bg-gray-500');

            if (netBalance > 0) {
                balanceEl.classList.add('bg-emerald-500');
            } else if (netBalance < 0) {
                balanceEl.classList.add('bg-red-500');
            } else {
                balanceEl.classList.add('bg-gray-500');
            }
        }

        /**
         * æ¸²æŸ“æ­·å²è¨˜éŒ„åˆ—è¡¨ã€‚
         */
        function renderHistory(transactions) {
            const listEl = document.getElementById('history-list');
            const emptyEl = document.getElementById('empty-state');
            const loadingEl = document.getElementById('loading-message');
            listEl.innerHTML = '';
            
            // éš±è—è¼‰å…¥è¨Šæ¯
            loadingEl.classList.add('hidden');

            if (transactions.length === 0) {
                emptyEl.classList.remove('hidden');
                return;
            }

            emptyEl.classList.add('hidden');

            transactions.forEach(tx => {
                const isExpense = tx.type === 'expense';
                const sign = isExpense ? '-' : '+';
                const colorClass = isExpense ? 'text-expense' : 'text-income';
                const borderColor = isExpense ? 'border-red-400' : 'border-emerald-400';

                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-4 bg-white rounded-xl border-l-4 ${borderColor} transition duration-150 shadow-sm`;
                item.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="text-base font-medium text-gray-800 truncate">${tx.description}</p>
                        <p class="text-xs text-gray-500 mt-0.5">${formatDate(tx.date)}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <p class="text-lg font-bold ${colorClass}">
                            ${sign} ${fmtMoney(tx.amount)}
                        </p>
                        <button onclick="deleteTransaction('${tx.id}')" class="text-gray-400 hover:text-red-600 transition duration-150 p-1 rounded-full hover:bg-red-50">
                            <!-- SVG åƒåœ¾æ¡¶åœ–æ¨™ -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                        </button>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        // --- 6. å•Ÿå‹•ç¨‹åº ---

        document.addEventListener('DOMContentLoaded', setupFirebase);
    </script>
</body>
</html>

