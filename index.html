<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端記帳本</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 使用 Inter 字體 */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        /* 確保容器在手機上居中且好看 */
        .container { max-width: 480px; margin: auto; padding: 1rem; min-height: 100vh; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header & User Info -->
        <header class="text-center mb-6 pt-4">
            <h1 class="text-3xl font-extrabold text-gray-900">雲端記帳本</h1>
            <p id="auth-status" class="text-xs text-gray-500 mt-1 text-red-500">連線中...</p>
            <p class="text-xs text-gray-500 mt-1 truncate">
                使用者 ID: <span id="user-id" class="font-mono text-gray-700">等待驗證...</span>
            </p>
        </header>

        <!-- Balance Summary -->
        <div class="flex justify-between gap-2 mb-6 p-4 bg-white rounded-xl shadow-lg">
            <div class="flex-1 p-2 text-center rounded-lg bg-green-50 text-green-700">
                <div class="text-sm font-medium">總收入</div>
                <div id="total-income" class="text-xl font-bold mt-1">NT$ 0</div>
            </div>
            <div class="flex-1 p-2 text-center rounded-lg bg-red-50 text-red-700">
                <div class="text-sm font-medium">總支出</div>
                <div id="total-expense" class="text-xl font-bold mt-1">NT$ 0</div>
            </div>
            <div class="flex-1 p-2 text-center rounded-lg bg-gray-700 text-white">
                <div class="text-sm font-medium">淨餘額</div>
                <div id="net-balance" class="text-xl font-bold mt-1">NT$ 0</div>
            </div>
        </div>

        <!-- New Transaction Form -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">新增交易 (資料將儲存在雲端)</h2>
            <form id="transaction-form">
                <!-- Type and Date -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">類型</label>
                        <select id="type" name="type" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            <option value="expense">支出</option>
                            <option value="income">收入</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                        <input type="date" id="date" name="date" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">描述</label>
                    <input type="text" id="description" name="description" placeholder="例如：午餐, 加班費" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                </div>

                <!-- Amount -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">金額 (NT$)</label>
                    <input type="number" id="amount" name="amount" placeholder="例如: 150" required min="0.01" step="0.01"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                </div>

                <button type="submit" id="submit-btn"
                    class="w-full py-3 bg-orange-600 text-white font-semibold rounded-xl hover:bg-orange-700 transition duration-150 shadow-lg shadow-orange-200 disabled:opacity-50">
                    確認新增到雲端
                </button>
            </form>
        </div>

        <!-- Transaction List -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">歷史記錄 (來自 Firestore)</h2>
            <div id="transaction-list" class="space-y-3">
                <p id="loading-message" class="text-gray-500 text-center py-4">
                    <svg class="animate-spin h-5 w-5 mr-3 inline text-orange-600" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" class="opacity-25"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    載入資料中...
                </p>
                <!-- Transactions will be inserted here by JavaScript -->
            </div>
        </div>

        <!-- Custom Alert Modal (for non-alert() environment) -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-red-600"></h3>
                <p id="modal-message" class="text-gray-700 mb-6"></p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition hidden">取消</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot, 
            addDoc, 
            deleteDoc, 
            doc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 全域變數聲明
        let db;
        let auth;
        let currentUserId = null;
        let transactionsCollectionRef = null;

        // 獲取執行環境提供的全域變數
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // HTML 元素
        const userIdEl = document.getElementById('user-id');
        const authStatusEl = document.getElementById('auth-status');
        const listEl = document.getElementById('transaction-list');
        const formEl = document.getElementById('transaction-form');
        const submitBtn = document.getElementById('submit-btn');
        const loadingMessageEl = document.getElementById('loading-message');

        // --- 輔助函數 ---

        /**
         * 格式化數字為 NT$ 貨幣字串。
         */
        function formatCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) return '0';
            return new Intl.NumberFormat('zh-TW', { 
                style: 'decimal', 
                minimumFractionDigits: 0 
            }).format(amount);
        }

        /**
         * 自訂模態框取代 window.confirm/alert
         * @param {string} title - 標題
         * @param {string} message - 內容訊息
         * @param {boolean} isConfirm - 是否為確認模式 (顯示取消按鈕)
         * @returns {Promise<boolean>} - 如果是確認模式，返回 Promise<boolean>
         */
        function showModal(title, message, isConfirm = false) {
            const modalEl = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            confirmBtn.textContent = isConfirm ? '確認刪除' : '確定';
            confirmBtn.className = isConfirm 
                ? 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition'
                : 'px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition';
            
            cancelBtn.classList.toggle('hidden', !isConfirm);
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');

            return new Promise(resolve => {
                const onConfirm = () => {
                    modalEl.classList.add('hidden');
                    modalEl.classList.remove('flex');
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                    resolve(true);
                };

                const onCancel = () => {
                    modalEl.classList.add('hidden');
                    modalEl.classList.remove('flex');
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                    resolve(false);
                };

                confirmBtn.addEventListener('click', onConfirm);
                cancelBtn.addEventListener('click', onCancel);
            });
        }


        // --- Firebase 初始化與授權 (強化版) ---

        async function initFirebase() {
            try {
                // 1. 初始化 App 和服務
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                let authSuccess = false;

                // 2. 嘗試 Custom Token 登入 (可能失敗，但要保持彈性)
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        authSuccess = true;
                    } catch (tokenError) {
                        // 捕捉無效 token 錯誤，並警告但繼續執行
                        console.warn("Custom Token sign-in failed (possibly invalid/expired token), attempting anonymous sign-in.", tokenError);
                    }
                }
                
                // 3. 嘗試匿名登入 (這是可靠的備用方案)
                if (!authSuccess) {
                    await signInAnonymously(auth);
                    authSuccess = true;
                }
                
                // 4. 只有在成功登入後才設定監聽器
                if (authSuccess) {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            userIdEl.textContent = currentUserId;
                            authStatusEl.textContent = '已連線到 Firestore';
                            authStatusEl.className = 'text-xs text-gray-500 mt-1 font-semibold text-green-600';
                            
                            // 設定 Firestore 集合路徑
                            // 使用公共路徑 /artifacts/{appId}/public/data/transactions
                            const collectionPath = `/artifacts/${appId}/public/data/transactions`;
                            transactionsCollectionRef = collection(db, collectionPath);
                            
                            startRealtimeListener(); // 身份驗證完成後開始監聽資料庫
                        } else {
                            // 應該不會走到這裡
                            userIdEl.textContent = '登入失敗 (請刷新重試)';
                            authStatusEl.textContent = '未授權';
                            authStatusEl.className = 'text-xs text-gray-500 mt-1 font-semibold text-red-600';
                            loadingMessageEl.textContent = '無法獲取授權，請重試。';
                        }
                    });
                } else {
                     // 如果 Custom Token 和匿名登入都失敗了
                     throw new Error("Failed to sign in via both methods.");
                }

            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                // 只有在連線或匿名登入失敗時才彈出致命錯誤
                showModal('連線錯誤', `無法連線到雲端服務，請檢查網路。錯誤訊息: ${error.message}`, false);
                loadingMessageEl.textContent = '連線失敗。';
            }
        }

        // --- 實時資料監聽與渲染 ---

        function startRealtimeListener() {
            if (!transactionsCollectionRef) return;
            
            // 查詢，但不使用 orderBy，避免需要額外索引
            const q = query(transactionsCollectionRef); 

            onSnapshot(q, (snapshot) => {
                const transactions = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    transactions.push({
                        id: doc.id,
                        ...data
                    });
                });

                // 在客戶端進行排序 (時間降序)
                transactions.sort((a, b) => {
                    const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : new Date(a.date).getTime();
                    const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : new Date(b.date).getTime();
                    return timeB - timeA;
                });
                
                renderTransactions(transactions);
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                loadingMessageEl.textContent = '載入資料失敗。';
            });
        }

        /**
         * 渲染交易列表和總結算。
         * @param {Array<Object>} transactions 交易記錄陣列
         */
        function renderTransactions(transactions) {
            let totalIncome = 0;
            let totalExpense = 0;
            listEl.innerHTML = ''; // 清空列表
            
            // 移除載入訊息
            loadingMessageEl.style.display = 'none';

            if (transactions.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-4">暫無交易記錄。新增一筆來開始記帳吧！</p>';
                document.getElementById('total-income').textContent = formatCurrency(0);
                document.getElementById('total-expense').textContent = formatCurrency(0);
                document.getElementById('net-balance').textContent = formatCurrency(0);
                return;
            }

            transactions.forEach(tx => {
                const isIncome = tx.type === 'income';
                const amount = parseFloat(tx.amount || 0);

                if (isIncome) {
                    totalIncome += amount;
                } else {
                    totalExpense += amount;
                }

                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-4 rounded-xl shadow-sm bg-white border-l-4 transition hover:shadow-md ${isIncome ? 'border-green-500' : 'border-red-500'}`;
                item.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold text-lg truncate text-gray-800">
                            ${isIncome ? '收入' : '支出'} - ${tx.category || '未分類'}
                        </div>
                        <div class="text-sm text-gray-500 truncate mt-0.5">
                            ${tx.description}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            ${tx.date}
                        </div>
                    </div>
                    <div class="flex items-center ml-4">
                        <span class="font-bold text-lg ${isIncome ? 'text-green-600' : 'text-red-600'}">
                            ${isIncome ? '+' : '-'} NT$ ${formatCurrency(amount)}
                        </span>
                        <button data-id="${tx.id}" class="delete-btn ml-3 p-1 rounded-full hover:bg-red-50 text-gray-400 hover:text-red-600 transition">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                listEl.appendChild(item);
            });

            // 更新總結算
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
            document.getElementById('net-balance').textContent = formatCurrency(totalIncome - totalExpense);

            // 重新渲染 Lucide 圖標
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // 重新綁定刪除事件
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteTransaction(e.currentTarget.dataset.id));
            });
        }

        // --- CRUD 邏輯 ---

        /**
         * 新增交易記錄。
         */
        formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!transactionsCollectionRef) {
                showModal('錯誤', '資料庫尚未連線，請稍候再試。', false);
                return;
            }

            // 禁用按鈕並顯示儲存中
            submitBtn.disabled = true;
            submitBtn.textContent = '儲存中...';

            const formData = new FormData(formEl);
            const newTxData = {
                type: formData.get('type'),
                date: formData.get('date'),
                description: formData.get('description'),
                amount: parseFloat(formData.get('amount')),
                category: '一般', // 預設類別
                userId: currentUserId,
                timestamp: serverTimestamp() // 確保使用伺服器時間戳
            };

            try {
                await addDoc(transactionsCollectionRef, newTxData);
                console.log("Transaction added successfully.");
                
                // 重置表單
                formEl.reset();
                // 設置日期為今天
                document.getElementById('date').value = new Date().toISOString().substring(0, 10);

            } catch (error) {
                console.error("Error adding document: ", error);
                showModal('新增失敗', `無法將資料儲存到雲端，錯誤訊息: ${error.message}`, false);
            } finally {
                // 啟用按鈕
                submitBtn.disabled = false;
                submitBtn.textContent = '確認新增到雲端';
            }
        });

        /**
         * 刪除交易記錄。
         * @param {string} id - 文件 ID
         */
        async function deleteTransaction(id) {
            const confirmed = await showModal('確認刪除', '您確定要永久刪除這筆交易記錄嗎？', true);
            
            if (!confirmed || !transactionsCollectionRef) return;

            try {
                const docRef = doc(db, transactionsCollectionRef.path, id);
                await deleteDoc(docRef);
                console.log("Transaction deleted:", id);
                // onSnapshot 會自動更新 UI
            } catch (error) {
                console.error("Error deleting document:", error);
                showModal('刪除失敗', `無法刪除交易，錯誤訊息: ${error.message}`, false);
            }
        }


        // --- 初始化 ---
        
        // 設置表單的預設日期為今天
        document.getElementById('date').value = new Date().toISOString().substring(0, 10);
        
        // 開始 Firebase 流程
        initFirebase();
    </script>
</body>
</html>

