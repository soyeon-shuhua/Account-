import { ChangeDetectionStrategy, Component, computed, signal } from '@angular/core';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, Auth } from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    query, 
    onSnapshot, 
    addDoc, 
    deleteDoc, 
    doc,
    Firestore,
    serverTimestamp,
    orderBy
} from 'firebase/firestore';

// 假設這些全域變數已由執行環境提供 (Canvas Context)
declare const __app_id: string | undefined;
declare const __firebase_config: string | undefined;
declare const __initial_auth_token: string | undefined;

interface Transaction {
    id: string; // Firestore document ID
    type: 'income' | 'expense';
    date: string;
    description: string;
    amount: number;
    category: string;
    timestamp: any; // Firestore Timestamp or Date
}

@Component({
    selector: 'app-root',
    standalone: true,
    template: `
        <div class="container mx-auto p-4 max-w-md">
            <!-- Header & User Info -->
            <header class="text-center mb-6 pt-4">
                <h1 class="text-3xl font-extrabold text-gray-900">雲端記帳本</h1>
                @if (userId()) {
                    <p class="text-xs text-gray-500 mt-1">
                        狀態: <span class="font-semibold text-green-600">已連線到 Firestore</span>
                    </p>
                    <p class="text-xs text-gray-500 mt-1 truncate">
                        使用者 ID: <span class="font-mono text-gray-700">{{ userId() }}</span>
                    </p>
                } @else {
                    <p class="text-xs text-gray-500 mt-1 text-red-500">
                        連線中...
                    </p>
                }
            </header>

            <!-- Balance Summary -->
            <div class="flex justify-between gap-2 mb-6 p-4 bg-white rounded-xl shadow-lg">
                <div class="flex-1 p-2 text-center rounded-lg bg-green-50 text-green-700">
                    <div class="text-sm font-medium">總收入</div>
                    <div class="text-xl font-bold mt-1">NT$ {{ formatCurrency(totalIncome()) }}</div>
                </div>
                <div class="flex-1 p-2 text-center rounded-lg bg-red-50 text-red-700">
                    <div class="text-sm font-medium">總支出</div>
                    <div class="text-xl font-bold mt-1">NT$ {{ formatCurrency(totalExpense()) }}</div>
                </div>
                <div class="flex-1 p-2 text-center rounded-lg bg-gray-700 text-white">
                    <div class="text-sm font-medium">淨餘額</div>
                    <div class="text-xl font-bold mt-1">NT$ {{ formatCurrency(netBalance()) }}</div>
                </div>
            </div>

            <!-- New Transaction Form -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">新增交易 (資料將儲存在雲端)</h2>
                <form #transactionForm="ngForm" (ngSubmit)="addTransaction(transactionForm)">
                    <!-- Type and Date -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">類型</label>
                            <select name="type" [(ngModel)]="newTransaction.type" required
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                                <option value="expense">支出</option>
                                <option value="income">收入</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                            <input type="date" name="date" [(ngModel)]="newTransaction.date" required
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">描述</label>
                        <input type="text" name="description" [(ngModel)]="newTransaction.description" placeholder="例如：午餐, 加班費" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                    </div>

                    <!-- Amount -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">金額 (NT$)</label>
                        <input type="number" name="amount" [(ngModel)]="newTransaction.amount" placeholder="例如: 150" required min="0.01" step="0.01"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                    </div>

                    <button type="submit" [disabled]="!transactionForm.valid || isSaving()"
                        class="w-full py-3 bg-orange-600 text-white font-semibold rounded-xl hover:bg-orange-700 transition duration-150 shadow-lg shadow-orange-200 disabled:opacity-50">
                        @if (isSaving()) {
                            儲存中...
                        } @else {
                            確認新增到雲端
                        }
                    </button>
                </form>
            </div>

            <!-- Transaction List -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">歷史記錄 (來自 Firestore)</h2>
                
                @if (transactions().length === 0) {
                    <p class="text-gray-500 text-center py-4">
                        @if (isAuthReady() && !isLoading()) {
                            暫無交易記錄。新增一筆來開始記帳吧！
                        } @else if (isLoading()) {
                            <i data-lucide="loader-2" class="inline-block w-5 h-5 mr-2 animate-spin"></i> 載入資料中...
                        } @else {
                            等待連線...
                        }
                    </p>
                }

                <div class="space-y-3">
                    @for (tx of transactions(); track tx.id) {
                        <div class="flex justify-between items-center p-4 rounded-xl shadow-sm bg-white border-l-4"
                             [class]="tx.type === 'income' ? 'border-green-500' : 'border-red-500'">
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-lg truncate text-gray-800">
                                    {{ tx.type === 'income' ? '收入' : '支出' }} - {{ tx.category || '未分類' }}
                                </div>
                                <div class="text-sm text-gray-500 truncate mt-0.5">
                                    {{ tx.description }}
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    {{ tx.date }}
                                </div>
                            </div>
                            <div class="flex items-center ml-4">
                                <span class="font-bold text-lg" [class]="tx.type === 'income' ? 'text-green-600' : 'text-red-600'">
                                    {{ tx.type === 'income' ? '+' : '-' }} NT$ {{ formatCurrency(tx.amount) }}
                                </span>
                                <button (click)="deleteTransaction(tx.id)"
                                    class="ml-3 p-1 rounded-full hover:bg-red-50 text-gray-400 hover:text-red-600 transition">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    `,
    styles: [`
        body { background-color: #f7f7f7; font-family: 'Inter', sans-serif; }
        .container { min-height: 100vh; padding-bottom: 30px; }
    `],
    changeDetection: ChangeDetectionStrategy.OnPush,
})
export class App {
    // Firebase 服務實例
    private db: Firestore;
    private auth: Auth;
    private appId: string;
    private transactionsCollectionPath: string = '';

    // 狀態信號 (Signals)
    userId = signal<string | null>(null);
    isAuthReady = signal(false);
    isLoading = signal(true);
    isSaving = signal(false);
    transactions = signal<Transaction[]>([]);
    
    // 表單資料模型
    newTransaction = {
        type: 'expense' as 'expense' | 'income',
        date: new Date().toISOString().substring(0, 10), // YYYY-MM-DD
        description: '',
        amount: null as number | null
    };

    constructor() {
        this.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : {};

        // 1. 初始化 Firebase App
        const app = initializeApp(firebaseConfig);
        this.db = getFirestore(app);
        this.auth = getAuth(app);
        
        // 確保設定日誌級別，幫助偵錯
        // setLogLevel('debug'); // 由於無法確定環境支持，此處註釋掉

        // 2. 處理身份驗證
        onAuthStateChanged(this.auth, (user) => {
            if (user) {
                this.userId.set(user.uid);
                this.isAuthReady.set(true);
                // 設置資料庫路徑：使用公共路徑 /artifacts/{appId}/public/data/transactions
                this.transactionsCollectionPath = `/artifacts/${this.appId}/public/data/transactions`;
                this.listenForTransactions(); // 身份驗證完成後開始監聽資料庫
            } else {
                this.isAuthReady.set(true); // 即使匿名也視為準備就緒
                this.handleAuth();
            }
        });

        // 如果 token 存在，嘗試使用 custom token 登入
        if (typeof __initial_auth_token !== 'undefined') {
            this.handleAuth();
        }
    }

    /**
     * 處理 Firebase 登入邏輯。
     */
    async handleAuth() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(this.auth, __initial_auth_token);
            } else {
                await signInAnonymously(this.auth);
            }
        } catch (error) {
            console.error("Firebase Authentication failed:", error);
            window.alert('錯誤: 無法登入 Firebase 服務。');
        }
    }

    /**
     * 監聽 Firestore 上的交易記錄。
     */
    listenForTransactions() {
        if (!this.transactionsCollectionPath) {
            console.warn("Firestore collection path not initialized.");
            return;
        }

        const q = query(collection(this.db, this.transactionsCollectionPath));

        // onSnapshot 提供實時更新
        onSnapshot(q, (querySnapshot) => {
            const transactions: Transaction[] = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                transactions.push({
                    id: doc.id,
                    type: data['type'] as 'income' | 'expense',
                    date: data['date'],
                    description: data['description'],
                    amount: data['amount'] || 0,
                    category: data['category'] || '未分類',
                    timestamp: data['timestamp'],
                });
            });

            // 排序 (由於 Firestore 預設不允許 order by，我們在客戶端排序)
            transactions.sort((a, b) => {
                const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : new Date(a.date).getTime();
                const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : new Date(b.date).getTime();
                return timeB - timeA; // 降序
            });

            this.transactions.set(transactions);
            this.isLoading.set(false);
            console.log(`Firestore Update: Received ${transactions.length} transactions.`);

        }, (error) => {
            console.error("Firestore snapshot listener failed:", error);
            this.isLoading.set(false);
            window.alert('錯誤: 無法從雲端載入資料。請檢查連線。');
        });
    }

    // --- Computed Signals for Summary ---

    totalIncome = computed(() => {
        return this.transactions()
            .filter(tx => tx.type === 'income')
            .reduce((sum, tx) => sum + tx.amount, 0);
    });

    totalExpense = computed(() => {
        return this.transactions()
            .filter(tx => tx.type === 'expense')
            .reduce((sum, tx) => sum + tx.amount, 0);
    });

    netBalance = computed(() => {
        return this.totalIncome() - this.totalExpense();
    });

    // --- CRUD Operations ---

    /**
     * 新增交易到 Firestore。
     */
    async addTransaction(form: any) {
        if (!this.transactionsCollectionPath || this.isSaving()) return;

        this.isSaving.set(true);

        const newTxData = {
            type: this.newTransaction.type,
            date: this.newTransaction.date,
            description: this.newTransaction.description,
            amount: parseFloat(this.newTransaction.amount!.toString()), // 確保為數字
            category: '分類中...', // 預設類別
            userId: this.userId(),
            timestamp: serverTimestamp() // 使用伺服器時間戳
        };

        try {
            const docRef = await addDoc(collection(this.db, this.transactionsCollectionPath), newTxData);
            console.log("Transaction added with ID: ", docRef.id);
            // 成功後，onSnapshot 會自動更新 transactions() signal
            
            // 重置表單和模型
            form.resetForm({ 
                type: 'expense', 
                date: new Date().toISOString().substring(0, 10),
                description: '',
                amount: null
            });

        } catch (e) {
            console.error("Error adding document: ", e);
            window.alert('錯誤: 無法新增交易到雲端資料庫。');
        } finally {
            this.isSaving.set(false);
        }
    }

    /**
     * 根據文件 ID 刪除交易。
     * @param id Firestore Document ID
     */
    async deleteTransaction(id: string) {
        if (!this.transactionsCollectionPath) return;

        const confirmed = await new Promise<boolean>((resolve) => {
            resolve(window.confirm('確定要刪除這筆交易記錄嗎？'));
        });
        if (!confirmed) return;

        try {
            const docRef = doc(this.db, this.transactionsCollectionPath, id);
            await deleteDoc(docRef);
            console.log("Transaction deleted: ", id);
            // onSnapshot 會自動更新 transactions() signal
        } catch (e) {
            console.error("Error deleting document: ", e);
            window.alert('錯誤: 無法刪除交易。');
        }
    }

    // --- Utility ---

    /**
     * 格式化數字為 NT$ 貨幣字串 (純顯示用，避免在 Computed 中過度執行)。
     * @param amount
     * @returns
     */
    formatCurrency(amount: number | null): string {
        if (amount === null || isNaN(amount)) return '0.00';
        // 簡化為無小數點顯示，視覺上更清晰
        return new Intl.NumberFormat('zh-TW', { style: 'decimal', minimumFractionDigits: 0 }).format(amount);
    }

    // 重新渲染 Lucide icons (需要手動呼叫)
    ngAfterViewChecked() {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
}

