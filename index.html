<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端記帳本 (分析與備份)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- 圖表函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <!-- PWA 核心：連結 manifest 檔案 -->
    <link rel="manifest" href="./manifest.json">
    
    <style>
        /* 確保 PWA 在獨立模式下運作順暢 */
        body {
            font-family: 'Inter', 'Microsoft JhengHei', 'sans-serif';
            background-color: #f0f4f8;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .text-income { color: #10b981; } 
        .text-expense { color: #ef4444; } 
        #app {
            padding-bottom: 20px;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
</head>
<body>

    <div id="app" class="max-w-md mx-auto p-4 sm:p-6 bg-white min-h-screen">
        <header class="text-center mb-6 pt-4">
            <h1 class="text-3xl font-extrabold text-gray-900">雲端記帳本</h1>
            <p id="user-id-display" class="text-xs text-gray-500 mt-1">
            </p>
        </header>

        <!-- 訊息彈窗: 用於取代 alert/confirm -->
        <div id="message-box" class="fixed top-0 left-1/2 -translate-x-1/2 w-11/12 max-w-sm z-50"></div>
        
        <!-- 連線錯誤警告 -->
        <div id="config-warning" class="bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 mb-4 rounded-lg hidden">
            <p class="font-bold">⚠️ 提醒：資料庫為測試模式</p>
            <p class="text-sm">此版本使用匿名登入。若需永久雲端同步，請替換程式碼中的 `mockFirebaseConfig`。</p>
        </div>

        <!-- 總結數據區塊 -->
        <div id="summary-section" class="mb-6 grid grid-cols-3 gap-3">
            <div class="card bg-white p-3 rounded-xl text-center border-l-4 border-emerald-500">
                <p class="text-xs text-gray-500 font-semibold">總收入</p>
                <p id="total-income" class="text-income text-lg font-bold mt-1">NT$ 0</p>
            </div>
            <div class="card bg-white p-3 rounded-xl text-center border-l-4 border-red-500">
                <p class="text-xs text-gray-500 font-semibold">總支出</p>
                <p id="total-expense" class="text-expense text-lg font-bold mt-1">NT$ 0</p>
            </div>
            <div id="net-balance-card" class="card p-3 rounded-xl text-white text-center transition duration-300 bg-gray-500">
                <p class="text-xs font-semibold">淨餘額</p>
                <p id="net-balance" class="text-lg font-bold mt-1">NT$ 0</p>
            </div>
        </div>

        <!-- 頁籤導覽 (Tabs) -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-record" onclick="showTab('record')" class="flex-1 p-3 text-sm font-medium transition duration-200 border-b-2 border-orange-500 text-orange-600">
                記帳
            </button>
            <button id="tab-analysis" onclick="showTab('analysis')" class="flex-1 p-3 text-sm font-medium transition duration-200 text-gray-500 border-b-2 border-transparent hover:text-gray-700">
                分析與備份
            </button>
        </div>

        <!-- 記帳分頁內容 -->
        <div id="content-record">
            <!-- 新增交易區塊 -->
            <section class="mb-8 p-5 bg-white rounded-2xl card border-t-8 border-orange-500">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">新增交易</h2>
                <div class="space-y-4">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <!-- 類型選擇 (收入/支出) -->
                        <div>
                            <label for="transaction-type" class="block text-sm font-medium text-gray-600 mb-1">類型</label>
                            <select id="transaction-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150">
                                <option value="expense">支出</option>
                                <option value="income">收入</option>
                            </select>
                        </div>
                        <!-- 日期選擇 -->
                        <div>
                            <label for="transaction-date" class="block text-sm font-medium text-gray-600 mb-1">日期</label>
                            <input type="date" id="transaction-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150" required>
                        </div>
                    </div>

                    <!-- 類別選擇 -->
                    <div>
                        <label for="transaction-category" class="block text-sm font-medium text-gray-600 mb-1">類別</label>
                        <select id="transaction-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150">
                            <!-- 選項將由 JS 動態生成 -->
                        </select>
                    </div>

                    <div>
                        <label for="transaction-description" class="block text-sm font-medium text-gray-600 mb-1">描述</label>
                        <input type="text" id="transaction-description" placeholder="例如: 午餐, 加班費" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150" required onclick="this.focus()">
                    </div>

                    <div>
                        <label for="transaction-amount" class="block text-sm font-medium text-gray-600 mb-1">金額 (NT$)</label>
                        <input type="number" id="transaction-amount" placeholder="例如: 150" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150" required onclick="this.focus()">
                    </div>

                    <button onclick="addTransaction()" id="add-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-lg transition duration-300 transform hover:scale-[1.01] shadow-lg shadow-orange-300">
                        確認新增
                    </button>
                </div>
            </section>

            <!-- 歷史記錄區塊 -->
            <section class="p-5 bg-white rounded-2xl card">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">歷史記錄</h2>
                <div id="history-list" class="space-y-3">
                    <p id="loading-message" class="text-center text-gray-500 py-4">連線中，請稍候...</p>
                </div>
            </section>

            <div id="empty-state" class="text-center p-6 bg-gray-100 rounded-lg hidden mt-4">
                <p class="text-gray-500 text-sm">暫無交易記錄。您的資料將儲存在雲端，請放心新增！</p>
            </div>
        </div>

        <!-- 分析與備份分頁內容 -->
        <div id="content-analysis" class="hidden space-y-8">
            <!-- 圖表分析區塊 -->
            <section class="p-5 bg-white rounded-2xl card border-t-8 border-blue-500">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">支出類別分析 (圓餅圖)</h2>
                <div class="relative h-64">
                    <canvas id="expense-chart"></canvas>
                    <p id="chart-loading" class="absolute inset-0 flex items-center justify-center text-gray-500 bg-white bg-opacity-80 rounded-lg">載入圖表中...</p>
                </div>
                <p id="chart-summary" class="text-sm text-gray-500 mt-4 text-center"></p>
            </section>

            <!-- 備份與還原區塊 -->
            <section class="p-5 bg-white rounded-2xl card border-t-8 border-green-500">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">備份與還原 (CSV)</h2>
                <div class="space-y-4">
                    <!-- 匯出 -->
                    <button onclick="exportDataAsCsv()" class="w-full flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-300 shadow-lg shadow-green-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text-up mr-2"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M12 8v8"/><path d="m15 13-3-3-3 3"/></svg>
                        匯出所有資料 (CSV 備份)
                    </button>
                    <!-- 隱藏的下載連結 -->
                    <a id="download-link" class="hidden"></a>

                    <!-- 匯入 -->
                    <label for="import-file" class="w-full flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition duration-300 shadow-lg shadow-blue-300 cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text-down mr-2"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M12 12v4"/><path d="m9 15 3 3 3-3"/></svg>
                        選擇 CSV 檔案還原/批次新增
                    </label>
                    <input type="file" id="import-file" accept=".csv" class="hidden" onchange="importDataFromCsv(event)">
                </div>
            </section>
        </div>


    </div>

    <!-- 編輯彈窗 Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-[999]">
        <div class="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl transform transition-all">
            <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">編輯交易記錄</h3>
            <div class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <div>
                    <label for="edit-type" class="block text-sm font-medium text-gray-600 mb-1">類型</label>
                    <select id="edit-type" class="w-full p-3 border border-gray-300 rounded-lg"></select>
                </div>
                
                <div>
                    <label for="edit-category" class="block text-sm font-medium text-gray-600 mb-1">類別</label>
                    <select id="edit-category" class="w-full p-3 border border-gray-300 rounded-lg"></select>
                </div>

                <div>
                    <label for="edit-description" class="block text-sm font-medium text-gray-600 mb-1">描述</label>
                    <input type="text" id="edit-description" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>

                <div>
                    <label for="edit-amount" class="block text-sm font-medium text-gray-600 mb-1">金額 (NT$)</label>
                    <input type="number" id="edit-amount" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
                
                <div>
                    <label for="edit-date" class="block text-sm font-medium text-gray-600 mb-1">日期</label>
                    <input type="date" id="edit-date" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeEditModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">取消</button>
                <button onclick="saveEditTransaction()" id="save-edit-button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">儲存更改</button>
            </div>
        </div>
    </div>


    <!-- Firebase 腳本及應用程式邏輯 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, updateDoc, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. 環境變數與設定 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // 模擬 Firebase 設定 (請使用者替換為自己的正式設定)
        const mockFirebaseConfig = {
            apiKey: "AIzaSyC-placeholder-for-test-only", 
            authDomain: "test-only.firebaseapp.com",
            projectId: "test-only-project",
            storageBucket: "test-only-project.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef0123456789",
        };

        let firebaseConfig = mockFirebaseConfig;
        let isMockConfig = true;

        try {
            const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            if (Object.keys(envConfig).length > 0 && envConfig.projectId !== 'your-project-id') {
                 firebaseConfig = envConfig;
                 isMockConfig = false;
            }
        } catch (e) {
            console.error("解析環境 Firebase 設定失敗，使用 Mock Config。", e);
        }

        if (isMockConfig) {
            document.getElementById('config-warning').classList.remove('hidden');
        }

        window.db = null;
        window.auth = null;
        window.userId = null;
        let transactionsCache = {}; // 用於儲存交易資料，方便編輯時查找和圖表計算
        let expenseChart = null; // Chart.js 實例

        // 交易類別設定
        const categories = {
            expense: ['食物', '交通', '娛樂', '房租/住宿', '帳單', '服飾', '醫療', '學習', '其他支出'],
            income: ['薪水', '獎金', '投資收入', '禮金', '其他收入']
        };

        // 綁定到 window 讓 HTML 可以直接呼叫
        window.addTransaction = addTransaction;
        window.deleteTransaction = deleteTransaction;
        window.openEditModal = openEditModal;
        window.saveEditTransaction = saveEditTransaction;
        window.closeEditModal = closeEditModal;
        window.showTab = showTab; // 頁籤切換
        window.exportDataAsCsv = exportDataAsCsv; // 匯出功能
        window.importDataFromCsv = importDataFromCsv; // 匯入功能

        // --- 輔助函式 ---
        function showMessage(message, type) {
            const box = document.getElementById('message-box');
            const colorMap = {
                success: 'bg-emerald-500',
                error: 'bg-red-500',
                warning: 'bg-amber-500'
            };
            
            const alertHtml = `
                <div class="${colorMap[type]} text-white p-3 mt-4 rounded-lg shadow-xl transition-all duration-300 ease-in-out transform scale-100 opacity-100 font-medium">
                    ${message}
                </div>
            `;
            
            box.innerHTML = alertHtml;
            
            setTimeout(() => {
                const element = box.querySelector('div');
                if (element) {
                    element.classList.remove('scale-100', 'opacity-100');
                    element.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => box.innerHTML = '', 300);
                }
            }, 3000);
        }

        function fmtMoney(amount) {
            return `NT$ ${Math.abs(amount).toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}/${month}/${day}`;
        }
        
        function formatInputDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function populateCategorySelect(selectId, type, initialValue = '') {
            const selectEl = document.getElementById(selectId);
            selectEl.innerHTML = ''; 

            const typeCategories = categories[type] || categories.expense;
            
            typeCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === initialValue) {
                    option.selected = true;
                }
                selectEl.appendChild(option);
            });
        }
        
        function updateCategoryOptions() {
            const newType = document.getElementById('transaction-type').value;
            populateCategorySelect('transaction-category', newType);
        }
        
        function showTab(tabName) {
            // 隱藏所有內容，重置所有按鈕樣式
            document.getElementById('content-record').classList.add('hidden');
            document.getElementById('content-analysis').classList.add('hidden');
            document.getElementById('tab-record').classList.remove('border-orange-500', 'text-orange-600');
            document.getElementById('tab-record').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('tab-analysis').classList.remove('border-orange-500', 'text-orange-600');
            document.getElementById('tab-analysis').classList.add('border-transparent', 'text-gray-500');

            // 顯示選中的內容，設置按鈕樣式
            const contentEl = document.getElementById(`content-${tabName}`);
            const tabEl = document.getElementById(`tab-${tabName}`);
            
            contentEl.classList.remove('hidden');
            tabEl.classList.remove('border-transparent', 'text-gray-500');
            tabEl.classList.add('border-orange-500', 'text-orange-600');

            // 如果切換到分析頁，立即重繪圖表
            if (tabName === 'analysis') {
                drawExpenseChart(Object.values(transactionsCache));
            }
        }


        // --- 2. Firebase 核心設定與驗證 ---

        async function setupFirebase() {
            setLogLevel('debug');

            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                if (initialAuthToken && !isMockConfig) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                
                window.userId = window.auth.currentUser.uid;
                
                document.getElementById('user-id-display').textContent = `ID: ${window.userId}`;
                
                document.getElementById('transaction-date').value = formatInputDate(new Date());
                
                updateCategoryOptions();
                document.getElementById('transaction-type').addEventListener('change', updateCategoryOptions);

                fetchTransactions();

            } catch (error) {
                console.error("Firebase 設定或登入失敗:", error);
                show