<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端記帳本 - HTML/JS</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 使用 Inter 字體 -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        /* 隱藏原生數字輸入框的上下箭頭 */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 md:p-8 lg:p-12">
        <div class="max-w-4xl mx-auto">

            <!-- 通知訊息區域 -->
            <div id="notification-container" class="fixed bottom-4 right-4 z-50 space-y-2">
                <!-- 訊息將透過 JavaScript 插入此處 -->
            </div>

            <header class="mb-8 rounded-xl bg-white p-6 shadow-lg">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">雲端記帳本</h1>
                <p class="text-sm text-gray-500 mb-4">您的資料將安全地儲存於雲端 Firestore</p>

                <!-- 連線與使用者狀態 -->
                <div class="flex items-center space-x-4 text-sm">
                    <!-- 連線狀態 -->
                    <div id="status-badge" class="rounded-full px-3 py-1 font-medium transition-colors duration-200">
                        連線中...
                    </div>
                    <!-- 使用者 ID -->
                    <div class="text-gray-600 truncate">
                        使用者 ID:
                        <span id="user-id-display" class="font-mono text-xs">等待驗證...</span>
                    </div>
                </div>
            </header>

            <!-- 總覽卡片 -->
            <section class="grid grid-cols-3 gap-4 mb-8 rounded-xl bg-white p-6 shadow-lg">
                <div class="text-center p-3 rounded-xl bg-green-50/50">
                    <p class="text-sm font-medium text-gray-500">總收入</p>
                    <p id="total-income" class="text-xl font-bold text-green-600 md:text-2xl">NT$0</p>
                </div>
                <div class="text-center p-3 rounded-xl bg-red-50/50">
                    <p class="text-sm font-medium text-gray-500">總支出</p>
                    <p id="total-expense" class="text-xl font-bold text-red-600 md:text-2xl">NT$0</p>
                </div>
                <div class="text-center p-3 rounded-xl bg-gray-50/50">
                    <p class="text-sm font-medium text-gray-500">淨餘額</p>
                    <p id="net-balance" class="text-xl font-bold md:text-2xl text-gray-800">NT$0</p>
                </div>
            </section>

            <!-- 新增交易區塊 -->
            <section class="mb-8 rounded-xl bg-white p-6 shadow-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">新增交易</h2>

                <form id="transaction-form" class="space-y-4">
                    <!-- 交易類別 (收入/支出) -->
                    <div>
                        <label for="tx-type" class="block text-sm font-medium text-gray-700">類型</label>
                        <select id="tx-type" name="type" required
                            class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base border-2 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                            <option value="expense">支出</option>
                            <option value="income">收入</option>
                        </select>
                    </div>

                    <!-- 日期 -->
                    <div>
                        <label for="tx-date" class="block text-sm font-medium text-gray-700">日期</label>
                        <input type="date" id="tx-date" name="date" required
                            class="mt-1 block w-full rounded-md border-gray-300 py-2 px-3 text-base border-2 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" />
                    </div>

                    <!-- 類別 (依類型動態變化) -->
                    <div>
                        <label for="tx-category" class="block text-sm font-medium text-gray-700">類別</label>
                        <select id="tx-category" name="category" required
                            class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base border-2 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>

                    <!-- 描述 -->
                    <div>
                        <label for="tx-description" class="block text-sm font-medium text-gray-700">描述</label>
                        <input type="text" id="tx-description" name="description" placeholder="例如：晚餐, 加班費" required
                            class="mt-1 block w-full rounded-md border-gray-300 py-2 px-3 text-base border-2 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" />
                    </div>

                    <!-- 金額 -->
                    <div>
                        <label for="tx-amount" class="block text-sm font-medium text-gray-700">金額 (NT$)</label>
                        <input type="number" id="tx-amount" name="amount" placeholder="例如：150" required min="0.01" step="0.01"
                            class="mt-1 block w-full rounded-md border-gray-300 py-2 px-3 text-base border-2 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" />
                    </div>

                    <!-- 確認新增按鈕 -->
                    <button type="submit" id="add-transaction-button" disabled
                        class="w-full rounded-md bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50 transition duration-150 ease-in-out flex items-center justify-center">
                        <span id="button-text">等待連線...</span>
                    </button>
                </form>
            </section>

            <!-- 歷史記錄區塊 -->
            <section class="rounded-xl bg-white p-6 shadow-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">歷史記錄</h2>

                <!-- 載入/錯誤/空狀態區塊 -->
                <div id="loading-state" class="text-center p-6 text-gray-500">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                    <p class="text-indigo-600 mt-4 text-lg">載入中...</p>
                </div>
                
                <div id="error-state" class="hidden rounded-lg bg-red-50 p-4 text-center text-red-600 shadow-md">
                    <div class="font-bold mb-1">連線錯誤或資料載入失敗</div>
                    <p id="error-message" class="text-sm"></p>
                    <p class="text-xs mt-2 text-red-500">請檢查您的 Firebase 組態和網路連線。</p>
                </div>

                <div id="empty-state" class="hidden flex-col items-center justify-center bg-gray-50 rounded-lg p-6 text-center text-gray-500">
                    <svg class="w-12 h-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <p class="text-lg font-medium">尚無任何交易記錄。</p>
                    <p class="text-sm mt-1">趕快新增一筆紀錄吧！</p>
                </div>

                <!-- 交易列表 -->
                <div id="transaction-list" class="space-y-3">
                    <!-- Transactions will be inserted here -->
                </div>
            </section>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp, 
            Timestamp,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // -----------------------------------------------------------------------
        // 1. 核心變數和常數
        // -----------------------------------------------------------------------
        const CURRENCY_CODE = 'TWD';
        const EXPENSE_CATEGORIES = ['餐飲', '交通', '娛樂', '服飾', '住房', '醫療', '教育', '其他'];
        const INCOME_CATEGORIES = ['薪水', '投資', '禮物', '其他'];
        
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;
        let isSyncing = true;
        let isAdding = false;
        const deletingIds = new Set(); // 用於追蹤正在刪除的交易
        let transactions = []; // 用於儲存即時交易資料
        
        // -----------------------------------------------------------------------
        // 2. DOM 元素
        // -----------------------------------------------------------------------
        const $statusBadge = document.getElementById('status-badge');
        const $userIdDisplay = document.getElementById('user-id-display');
        const $transactionForm = document.getElementById('transaction-form');
        const $txType = document.getElementById('tx-type');
        const $txCategory = document.getElementById('tx-category');
        const $txDate = document.getElementById('tx-date');
        const $addButton = document.getElementById('add-transaction-button');
        const $buttonText = document.getElementById('button-text');
        const $totalIncome = document.getElementById('total-income');
        const $totalExpense = document.getElementById('total-expense');
        const $netBalance = document.getElementById('net-balance');
        const $transactionList = document.getElementById('transaction-list');
        const $loadingState = document.getElementById('loading-state');
        const $emptyState = document.getElementById('empty-state');
        const $errorState = document.getElementById('error-state');
        const $errorMessage = document.getElementById('error-message');
        const $notificationContainer = document.getElementById('notification-container');

        // -----------------------------------------------------------------------
        // 3. UI/工具函式
        // -----------------------------------------------------------------------

        /** 格式化金額為貨幣格式 */
        function formatCurrency(amount) {
            const formatter = new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: CURRENCY_CODE,
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            });
            return formatter.format(amount);
        }

        /** 格式化 Date 對象為 'YYYY/MM/DD' 字串 (用於顯示) */
        function formatDateForDisplay(date) {
            // 注意：這裡接收的是 Firestore 儲存的 YYYY-MM-DD 字串
            if (!date) return 'N/A';
            const parts = date.split('-');
            if (parts.length === 3) {
                 return `${parts[0]}/${parts[1]}/${parts[2]}`;
            }
            return date; // 返回原始值以防格式錯誤
        }

        /**
         * 顯示通知訊息
         * @param {string} message 訊息內容
         * @param {'success' | 'error' | 'info'} type 訊息類型
         */
        function showNotification(message, type) {
            const id = `notif-${Date.now()}`;
            const colorMap = {
                success: 'bg-green-100 text-green-700 border-green-400',
                error: 'bg-red-100 text-red-700 border-red-400',
                info: 'bg-blue-100 text-blue-700 border-blue-400'
            };

            const html = `
                <div id="${id}" class="rounded-lg p-4 shadow-xl transition-opacity duration-300 border-l-4 ${colorMap[type]}" role="alert">
                    <div class="flex items-center">
                        <svg class="h-6 w-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : ''}
                            ${type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : ''}
                            ${type === 'info' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : ''}
                        </svg>
                        <span class="font-medium">${message}</span>
                    </div>
                </div>
            `;

            $notificationContainer.insertAdjacentHTML('beforeend', html);
            
            // 自動移除
            setTimeout(() => {
                const element = document.getElementById(id);
                if (element) {
                    element.remove();
                }
            }, 3000);
        }

        /** 處理錯誤並更新 UI 狀態 */
        function handleError(message, context = 'general') {
            console.error(`[Firebase Error - ${context}] ${message}`);
            $errorState.classList.remove('hidden');
            $errorMessage.textContent = message;
            
            $statusBadge.className = 'rounded-full px-3 py-1 font-medium bg-red-100 text-red-700';
            $statusBadge.textContent = '連線錯誤';
            
            showNotification(`錯誤: ${message.substring(0, 50)}...`, 'error');
            
            // 確保載入狀態被隱藏
            $loadingState.classList.add('hidden');
        }

        /** 更新表單按鈕和狀態標籤 */
        function updateUIState() {
            const isConnected = isAuthReady && !isSyncing;
            $addButton.disabled = !isConnected || isAdding;

            if (isAdding) {
                $buttonText.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>儲存中...`;
            } else if (isConnected) {
                $buttonText.textContent = '確認新增到雲端';
            } else if (!isAuthReady) {
                $buttonText.textContent = '等待連線...';
            } else if (isSyncing) {
                 $buttonText.textContent = '同步中...';
            }
            
            if (!isAuthReady) {
                 $statusBadge.className = 'rounded-full px-3 py-1 font-medium bg-yellow-100 text-yellow-700';
                 $statusBadge.textContent = '連線中...';
            } else if (isSyncing) {
                 $statusBadge.className = 'rounded-full px-3 py-1 font-medium bg-blue-100 text-blue-700';
                 $statusBadge.textContent = '同步中...';
            } else if (isConnected) {
                 $statusBadge.className = 'rounded-full px-3 py-1 font-medium bg-green-100 text-green-700';
                 $statusBadge.textContent = '已連線';
            }
        }

        /** 渲染交易列表和總覽數據 */
        function renderTransactions(txs) {
            transactions = txs; // 更新本地緩存
            $transactionList.innerHTML = '';
            
            // 隱藏所有狀態，根據數據決定顯示哪個
            $loadingState.classList.add('hidden');
            $errorState.classList.add('hidden');
            $emptyState.classList.add('hidden');
            
            if (txs.length === 0 && !isSyncing) {
                $emptyState.classList.remove('hidden');
            } else if (txs.length > 0) {
                
                // 1. 計算總覽數據
                let totalIncome = 0;
                let totalExpense = 0;
                txs.forEach(tx => {
                    if (tx.type === 'income') {
                        totalIncome += tx.amount;
                    } else {
                        totalExpense += tx.amount;
                    }
                });
                const netBalance = totalIncome - totalExpense;

                $totalIncome.textContent = formatCurrency(totalIncome);
                $totalExpense.textContent = formatCurrency(totalExpense);
                $netBalance.textContent = formatCurrency(netBalance);
                $netBalance.className = `text-xl font-bold md:text-2xl ${netBalance > 0 ? 'text-green-600' : netBalance < 0 ? 'text-red-600' : 'text-gray-800'}`;


                // 2. 渲染列表
                txs.forEach(tx => {
                    const isExpense = tx.type === 'expense';
                    const isDeleting = deletingIds.has(tx.id);
                    
                    const transactionElement = document.createElement('div');
                    transactionElement.className = `flex items-center justify-between rounded-xl p-4 shadow-sm transition-all duration-150 ${isExpense ? 'bg-red-50 border-l-4 border-red-400' : 'bg-green-50 border-l-4 border-green-400'}`;
                    transactionElement.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <!-- 描述 / 日期 -->
                            <p class="font-bold truncate text-gray-800">${tx.description}</p>
                            <p class="text-xs text-gray-500 mt-0.5">
                                ${formatDateForDisplay(tx.date)}
                                <span class="mx-1">•</span>
                                <span class="text-xs font-semibold rounded-full px-2 py-0.5 ${isExpense ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}">${tx.category}</span>
                            </p>
                        </div>

                        <div class="flex items-center space-x-3 ml-4">
                            <!-- 金額 -->
                            <span class="text-lg font-bold ${isExpense ? 'text-red-600' : 'text-green-600'}">
                                ${isExpense ? '-' : '+'}
                                ${formatCurrency(tx.amount)}
                            </span>

                            <!-- 刪除按鈕 -->
                            <button data-id="${tx.id}" class="delete-btn p-2 rounded-full hover:bg-red-100 text-red-500 transition duration-150" ${isDeleting ? 'disabled' : ''}>
                                ${isDeleting 
                                    ? '<div class="animate-spin w-5 h-5 border-t-2 border-red-500 rounded-full"></div>'
                                    : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>'
                                }
                            </button>
                        </div>
                    `;
                    $transactionList.appendChild(transactionElement);
                });
                
                // 重新綁定刪除事件
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.getAttribute('data-id');
                        if (id) deleteTransaction(id